# 台球教练 (Billiard Trainer) 代码库总结

本文档按目录结构说明每个文件的作用与职责。

---

## 一、项目根目录

| 文件/目录 | 作用 |
|----------|------|
| **README.md** | 项目说明：产品定位、功能特性、技术架构、物理引擎与颗星公式简介、开发计划、内购项目、运行方式、文档索引。 |
| **.gitignore** | Git 忽略规则（如 Xcode 用户数据、构建产物等）。 |
| **docs/** | 产品与研发文档目录（phase1–phase6 产品定位、教学体系、技术方案、合规、路线图、执行计划）。 |
| **BilliardTrainer/** | 主应用源码目录。 |
| **BilliardTrainer.xcodeproj/** | Xcode 工程配置（`project.pbxproj` 等），构建与目标设置。 |

---

## 二、App 层（应用入口与主界面）

### BilliardTrainer/App/

| 文件 | 作用 |
|------|------|
| **BilliardTrainerApp.swift** | **应用入口**：`@main` 启动；配置 SwiftData `ModelContainer`（`UserProfile`、`CourseProgress`、`UserStatistics`、`TrainingSession`）；根视图为 `ContentView` 并注入 `AppState`。**AppState**：全局状态（是否首次启动、当前用户）；`loadOrCreateUser` 加载/创建用户；`saveTrainingSession` 保存训练会话并更新 `UserStatistics`。 |
| **ContentView.swift** | **主内容视图**：根据 `AppState.isFirstLaunch` 与 `showOnboarding` 决定显示 `OnboardingView` 或 `MainTabView`。**MainTabView**：底部 Tab（首页、课程、训练、统计、设置），绿色主题。 |

---

## 三、Core 层（核心模块）

### BilliardTrainer/Core/Aiming/

| 文件 | 作用 |
|------|------|
| **AimingSystem.swift** | **瞄准系统**：**AimingCalculator**：根据母球、目标球、袋口及塞（spinX/spinY）计算瞄准点、厚度、分离角、母球预计落点、是否可进袋、难度(1–5)；厚度描述（全厚/厚球/半球/薄球/极薄）；走位区域评分 **PositionZone**。**GhostBallAiming**：虚拟球法——计算虚拟球位置、判断是否被其他球遮挡。 |
| **DiamondSystem.swift** | **颗星公式系统**：**DiamondSystemCalculator**：颗星位置与世界坐标（`DiamondPosition`、`TableEdge`）；一库翻袋、两库 K 球、三库颗星公式（`DiamondResult`）；塞修正、速度修正。**BankShotCalculator**：翻袋瞄准（镜像法、与库边交点）。 |

### BilliardTrainer/Core/Audio/

| 文件 | 作用 |
|------|------|
| **AudioManager.swift** | **音效管理单例**：预定义音效类型（击球、碰撞、库边、进袋、成功/失败、连击、倒计时、按钮）；系统音效临时方案；击球/碰撞/库边按力度或冲量选不同音效；震动反馈（UIImpactFeedback / UINotificationFeedback）；与 `UserProfile` 同步音效/震动开关；支持加载自定义音效文件。 |

### BilliardTrainer/Core/Physics/

| 文件 | 作用 |
|------|------|
| **PhysicsEngine.swift** | **物理引擎**：基于 `BilliardScene` 的 60Hz 定时更新；球体滑动/滚动判定；滑动摩擦、滚动摩擦、旋转衰减；球静止时发送 `ballsAtRest` 通知；球与球碰撞时旋转传递；球与库边碰撞时塞修正；轨迹预测（含边界与反弹）；定义 `ballsAtRest`、`ballPocketed`、`collision` 通知名。 |

### BilliardTrainer/Core/Scene/

| 文件 | 作用 |
|------|------|
| **BilliardScene.swift** | **SceneKit 台球场景**：环境与灯光；球台（台面、库边、袋口、颗星）；母球与目标球创建（物理体、颜色、花色条纹占位）；相机模式（2D 俯视、3D 透视、击球视角、自由）；瞄准线显示/隐藏；场景重置。内附 **SCNVector3** 扩展（长度、归一化、点积、叉积、加减、标量乘）。 |
| **BilliardSceneView.swift** | **SwiftUI 包装 SceneKit**：**BilliardSceneView**（`UIViewRepresentable`）：绑定 `BilliardSceneViewModel`、手势（单指拖拽瞄准/旋转、双指捏合缩放、双指平移俯仰、双击切换视角、单击命中测试、长按蓄力击球）、物理碰撞代理。**BilliardSceneViewModel**：场景与游戏状态（idle/aiming/charging/ballsMoving/turnEnd）；按训练类型设置场景（瞄准/杆法/翻袋/K 球）；瞄准方向与瞄准线、打点与旋转、击球执行；相机模式切换；进袋与音效回调。 |

---

## 四、Features 层（功能模块）

### BilliardTrainer/Features/Home/

| 文件 | 作用 |
|------|------|
| **HomeView.swift** | **首页**：用户信息卡片（等级、经验条）、快捷入口（继续学习、快速练习）、学习进度（课程进度条）、今日统计（练习时长、进球数、进球率）。 |
| **OnboardingView.swift** | **首次启动引导**：多页 TabView（欢迎、系统化课程、真实物理引擎）；页面指示器；“下一步/开始使用”“跳过”；`OnboardingPage` 与 `OnboardingPageView`。 |

### BilliardTrainer/Features/Course/

| 文件 | 作用 |
|------|------|
| **CourseListView.swift** | **课程列表**：分区展示入门（免费 L1–L3）、基础（¥18 L4–L8）、进阶（¥25 L9–L14）、高级（¥20 L15–L18）；**CourseSection**、**CourseCard**；**Course** 模型含静态课程数据与完成状态。 |

### BilliardTrainer/Features/Training/

| 文件 | 作用 |
|------|------|
| **TrainingListView.swift** | **训练场列表**：**TrainingGroundCard** 展示各训练场（瞄准、杆法、翻袋、K 球、颗星），难度星级、最佳记录、锁定状态；**ChallengeSection**（单球挑战、走位挑战）；**TrainingGround** 模型与静态数据。 |
| **TrainingDetailView.swift** | **训练详情**：训练场头部、难度选择（1–5 星）、训练说明、历史最佳、开始训练；根据 `ground.id` 创建对应 `TrainingConfig`，以 fullScreenCover 打开 **TrainingSceneView**。 |
| **TrainingSceneView.swift** | **训练场景全屏视图**：嵌入 **BilliardSceneView**；顶部 HUD（暂停、得分、进球进度、限时、连击）；底部操作提示；暂停菜单（继续/重开/退出）；训练完成结果浮层（星级、得分、统计、返回/再来一次）；退出确认弹窗。 |
| **TrainingViewModel.swift** | **训练业务逻辑**：得分、进球数、击球数、连击、限时；与 `BilliardSceneViewModel` 绑定；开始/暂停/恢复/结束/重开；按 `TrainingConfig` 设置场景；计时器；进袋/未进袋处理与下一球重置；计算 **TrainingResult**（星级算法）。 |
| **Models/TrainingConfig.swift** | **训练配置与相关模型**：**TrainingConfig**（groundId、难度、球位、目标区、限时、目标进球数、训练类型）；预设配置（aiming/spin/bankShot/kickShot/diamond）；**TrainingSceneType**、**BallPosition**、**TargetZone**、**TrainingResult**（含星级计算）。 |

### BilliardTrainer/Features/Statistics/

| 文件 | 作用 |
|------|------|
| **StatisticsView.swift** | **统计页**：总览（总练习时长、总进球、平均进球率）；按角度进球率（直球、30°/45°/60°）；本周练习柱状图；技能雷达图占位（标注 V1.2）。 |

### BilliardTrainer/Features/Settings/

| 文件 | 作用 |
|------|------|
| **SettingsView.swift** | **设置页**：游戏设置（音效、震动、瞄准辅助线、轨迹预测）存于 `@AppStorage`；购买管理（已购内容、恢复购买）；关于（版本、隐私政策、使用帮助）；反馈（邮件、评分）。**PurchasedContentView**、**PurchaseRow**、**HelpView**、**HelpItem** 为子视图与帮助文案。 |

---

## 五、Models（数据模型）

### BilliardTrainer/Models/

| 文件 | 作用 |
|------|------|
| **UserProfile.swift** | **SwiftData 模型**：**UserProfile**（id、昵称、等级、经验、创建/最后活跃时间、已购产品、音效/震动/瞄准线/轨迹开关）；等级与经验条逻辑。**CourseProgress**（用户、课程 ID、完成状态、分数、练习次数）。**UserStatistics**（总练习时长、总进球/击球、按角度与杆法统计、签到、格式化与更新方法）。**TrainingSession**（会话 ID、用户、训练类型、起止时间、击球/进球/得分、时长与进球率）。 |

---

## 六、Utilities（工具与常量）

### BilliardTrainer/Utilities/Constants/

| 文件 | 作用 |
|------|------|
| **PhysicsConstants.swift** | **物理与系统常量**：**BallPhysics**（直径、半径、质量、弹性、摩擦、滚动阻尼）；**TablePhysics**（球台尺寸、库边、袋口、颗星数等）；**SpinPhysics**（旋转与摩擦参数）；**StrokePhysics**（击球速度范围）；**AimingSystem**（瞄准线长度、轨迹点数与步长）；**CameraSettings**（视角与距离）；**DiamondSystem**（颗星系数）；**SeparationAngle**（分离角常数）；**BallColors**（母球、黑八、全色/花色球 RGB）。 |

### BilliardTrainer/Utilities/Extensions/

| 文件 | 作用 |
|------|------|
| **Extensions.swift** | **通用扩展**：Color（台球绿、库边绿、木质色）；View（cardStyle、primaryButtonStyle、secondaryButtonStyle）；Double/Float（角度/弧度、百分比）；Date（是否今天、格式化、相对时间）；Array（安全下标）；CGPoint（距离、归一化）；String（本地化占位）；Int（星级显示、短数字）；TimeInterval（时分秒）；UIColor（hex）；**HapticFeedback** 枚举（轻/中/重/成功/警告/错误）。 |

---

## 七、Resources（资源）

### BilliardTrainer/Resources/

| 文件/目录 | 作用 |
|----------|------|
| **Info.plist** | App 配置：显示名「球道」、最低 iOS 17、启动 Storyboard、横竖屏、权限与能力等。 |
| **LaunchScreen.storyboard** | 启动屏 UI。 |
| **billiard_table.usdz** | 3D 球台资源（可选，当前场景以代码生成球台为主）。 |
| **Assets.xcassets/** | 资源目录：AccentColor、AppIcon（含 球道-logo-3.png）、Contents.json。 |

---

## 八、文档目录 docs/

| 文件 | 作用 |
|------|------|
| **phase1_产品定位.md** | 产品定位与目标用户。 |
| **phase2_教学体系设计.md** | 18 节课程与训练体系设计。 |
| **phase3_技术方案与系统架构.md** | 技术选型与架构说明。 |
| **phase4_AppStore合规与产品要求.md** | 上架与合规要求。 |
| **phase5_V1范围与路线图.md** | V1 功能范围与版本规划。 |
| **phase6_详细执行计划.md** | 具体开发与迭代计划。 |

---

## 九、数据流与依赖关系概览

- **AppState** 通过 `ContentView` 注入，供首页等使用；与 SwiftData 一起完成用户与训练会话持久化。
- **BilliardScene** 使用 **PhysicsConstants** 中的球台与球参数；**PhysicsEngine** 依赖 **BilliardScene** 做物理更新与碰撞。
- **AimingSystem**、**DiamondSystem** 使用 **PhysicsConstants** 的球半径与球台尺寸；**BilliardSceneViewModel** 使用 **AimingSystem** 的瞄准线长度等。
- **TrainingViewModel** 持有 **BilliardSceneViewModel**，按 **TrainingConfig** 驱动场景类型与难度；**TrainingSceneView** 同时使用 **TrainingViewModel** 与 **BilliardSceneView**。
- **AudioManager** 在 **BilliardSceneView.Coordinator** 的碰撞回调和击球逻辑中被调用；可与 **UserProfile** 同步开关。

---

## 十、当前实现状态简要说明

- **已完成**：应用框架、Tab 导航、引导页、课程/训练/统计/设置 UI、SwiftData 模型与 AppState 持久化、SceneKit 球台与球、瞄准与击球交互、物理与颗星/瞄准计算、训练流程与结果、音效与震动。
- **待完善**：课程详情与学习进度绑定真实数据、训练数据与统计页/UserStatistics 打通、内购与恢复购买、轨迹预测 UI、障碍球检测、球进袋后与 TrainingViewModel 的完整事件链（当前有 TODO）、技能雷达图与更多统计维度。

以上为当前代码库的文件级总结与职责说明。
