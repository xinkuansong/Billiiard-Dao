# 步骤1：项目搭建与基础架构

## 目标
从零开始创建Xcode项目，搭建完整的项目架构和目录结构。

**预计时间**: 2-3天
**优先级**: P0（必须完成）

---

## 一、创建Xcode项目

### 1.1 新建项目

**步骤**:
1. 打开Xcode
2. 选择 `File > New > Project`
3. 选择 `iOS > App`
4. 配置项目信息：
   - Product Name: `BilliardTrainer`
   - Team: 选择你的开发团队
   - Organization Identifier: `com.yourcompany`
   - Interface: `SwiftUI`
   - Language: `Swift`
   - Storage: `SwiftData`
   - 不勾选 Include Tests（后续手动添加）
5. 选择保存位置
6. 点击 Create

**验收标准**:
- [ ] 项目可以成功编译
- [ ] 可以在模拟器上运行
- [ ] 显示默认的 "Hello, World!" 界面

### 1.2 配置项目设置

**步骤**:
1. 选择项目根节点
2. 在 `General` 标签页配置：
   - Display Name: `球道`
   - Bundle Identifier: `com.yourcompany.BilliardTrainer`
   - Version: `1.0.0`
   - Build: `1`
   - Minimum Deployments: `iOS 17.0`
   - Supported Destinations: 仅勾选 `iPhone`
   - Device Orientation: 勾选 `Portrait`
3. 在 `Signing & Capabilities` 配置：
   - 选择你的开发团队
   - 确保 Automatically manage signing 已勾选
4. 在 `Info` 标签页添加：
   - Privacy - Camera Usage Description: "用于拍摄训练视频（可选功能）"
   - 其他隐私权限根据需要添加

**验收标准**:
- [ ] 项目配置正确
- [ ] 签名配置成功
- [ ] 可以在真机上运行

---

## 二、创建目录结构

### 2.1 删除默认文件

**步骤**:
1. 删除 `ContentView.swift`（我们会重新创建）
2. 保留 `BilliardTrainerApp.swift`

### 2.2 创建核心目录

**步骤**:
在 `BilliardTrainer` 目录下创建以下文件夹结构：

```
BilliardTrainer/
├── App/                          # 应用入口
│   ├── BilliardTrainerApp.swift  # 已存在
│   ├── AppState.swift            # 待创建
│   └── ContentView.swift         # 待创建
│
├── Features/                     # 功能模块
│   ├── Home/                     # 首页
│   │   ├── HomeView.swift
│   │   └── OnboardingView.swift
│   ├── Course/                   # 课程
│   │   ├── Views/
│   │   ├── ViewModels/
│   │   └── Models/
│   ├── Training/                 # 训练
│   │   ├── Views/
│   │   ├── ViewModels/
│   │   └── Models/
│   ├── Statistics/               # 统计
│   │   └── StatisticsView.swift
│   └── Settings/                 # 设置
│       └── SettingsView.swift
│
├── Core/                         # 核心模块
│   ├── Physics/                  # 物理引擎
│   │   ├── PhysicsEngine.swift
│   │   ├── BallNode.swift
│   │   ├── TableNode.swift
│   │   └── CollisionHandler.swift
│   ├── Aiming/                   # 瞄准系统
│   │   ├── AimingSystem.swift
│   │   └── DiamondSystem.swift
│   ├── Scene/                    # 场景
│   │   ├── BilliardScene.swift
│   │   └── BilliardSceneView.swift
│   └── Audio/                    # 音效
│       └── AudioManager.swift
│
├── Models/                       # 数据模型
│   └── UserProfile.swift
│
├── Services/                     # 服务层
│   ├── DataService.swift
│   └── IAPService.swift
│
├── Utilities/                    # 工具类
│   ├── Constants/
│   │   └── PhysicsConstants.swift
│   └── Extensions/
│       └── Extensions.swift
│
└── Resources/                    # 资源文件
    ├── Assets.xcassets
    ├── Info.plist
    └── LaunchScreen.storyboard
```

**操作方法**:
1. 在Xcode左侧项目导航器中右键点击 `BilliardTrainer`
2. 选择 `New Group`
3. 按照上述结构创建所有文件夹
4. 注意：创建 Group 而不是 Folder Reference

**验收标准**:
- [ ] 所有文件夹已创建
- [ ] 文件夹结构清晰
- [ ] 项目仍可编译

---

## 三、配置Git版本控制

### 3.1 初始化Git仓库

**步骤**:
```bash
cd /Users/song/projects/01.billiard_app
git init
```

### 3.2 创建.gitignore

**步骤**:
创建 `.gitignore` 文件，内容如下：

```gitignore
# Xcode
*.xcodeproj/*
!*.xcodeproj/project.pbxproj
!*.xcodeproj/xcshareddata/
!*.xcworkspace/contents.xcworkspacedata
*.xcworkspace/*
!*.xcworkspace/xcshareddata/

# User-specific files
*.xcuserstate
*.xcuserdatad/
xcuserdata/

# Build products
build/
DerivedData/
*.ipa
*.dSYM.zip
*.dSYM

# Swift Package Manager
.swiftpm/
Packages/
Package.resolved

# CocoaPods
Pods/
*.podspec

# Carthage
Carthage/Build/

# fastlane
fastlane/report.xml
fastlane/Preview.html
fastlane/screenshots/**/*.png
fastlane/test_output

# macOS
.DS_Store
.AppleDouble
.LSOverride

# Thumbnails
._*

# Files that might appear in the root of a volume
.DocumentRevisions-V100
.fseventsd
.Spotlight-V100
.TemporaryItems
.Trashes
.VolumeIcon.icns
.com.apple.timemachine.donotpresent

# Directories potentially created on remote AFP share
.AppleDB
.AppleDesktop
Network Trash Folder
Temporary Items
.apdisk
```

### 3.3 首次提交

**步骤**:
```bash
git add .
git commit -m "Initial commit: Project setup and directory structure"
```

**验收标准**:
- [ ] Git仓库已初始化
- [ ] .gitignore 配置正确
- [ ] 首次提交成功

---

## 四、创建基础文件

### 4.1 创建 AppState.swift

**位置**: `App/AppState.swift`

**代码**:
```swift
import SwiftUI
import SwiftData

@Observable
class AppState {
    var isFirstLaunch: Bool
    var currentUser: UserProfile?

    private var modelContext: ModelContext?

    init() {
        // 检查是否首次启动
        self.isFirstLaunch = !UserDefaults.standard.bool(forKey: "hasLaunchedBefore")
    }

    func configure(modelContext: ModelContext) {
        self.modelContext = modelContext
        loadOrCreateUser()
    }

    func loadOrCreateUser() {
        guard let context = modelContext else { return }

        let descriptor = FetchDescriptor<UserProfile>()
        let users = try? context.fetch(descriptor)

        if let user = users?.first {
            currentUser = user
        } else {
            // 创建新用户
            let newUser = UserProfile(nickname: "台球学员")
            context.insert(newUser)
            currentUser = newUser
            try? context.save()
        }
    }

    func completeOnboarding() {
        isFirstLaunch = false
        UserDefaults.standard.set(true, forKey: "hasLaunchedBefore")
    }
}
```

### 4.2 创建 ContentView.swift

**位置**: `App/ContentView.swift`

**代码**:
```swift
import SwiftUI

struct ContentView: View {
    @Environment(AppState.self) private var appState
    @State private var showOnboarding = false

    var body: some View {
        Group {
            if appState.isFirstLaunch || showOnboarding {
                OnboardingView(showOnboarding: $showOnboarding)
            } else {
                MainTabView()
            }
        }
        .onAppear {
            showOnboarding = appState.isFirstLaunch
        }
    }
}

struct MainTabView: View {
    var body: some View {
        TabView {
            HomeView()
                .tabItem {
                    Label("首页", systemImage: "house.fill")
                }

            CourseListView()
                .tabItem {
                    Label("课程", systemImage: "book.fill")
                }

            TrainingListView()
                .tabItem {
                    Label("训练", systemImage: "target")
                }

            StatisticsView()
                .tabItem {
                    Label("统计", systemImage: "chart.bar.fill")
                }

            SettingsView()
                .tabItem {
                    Label("设置", systemImage: "gearshape.fill")
                }
        }
        .tint(.green)
    }
}

#Preview {
    ContentView()
        .environment(AppState())
}
```

### 4.3 修改 BilliardTrainerApp.swift

**位置**: `App/BilliardTrainerApp.swift`

**代码**:
```swift
import SwiftUI
import SwiftData

@main
struct BilliardTrainerApp: App {
    @State private var appState = AppState()

    var sharedModelContainer: ModelContainer = {
        let schema = Schema([
            UserProfile.self,
            CourseProgress.self,
            UserStatistics.self,
            TrainingSession.self
        ])
        let modelConfiguration = ModelConfiguration(schema: schema, isStoredInMemoryOnly: false)

        do {
            return try ModelContainer(for: schema, configurations: [modelConfiguration])
        } catch {
            fatalError("Could not create ModelContainer: \(error)")
        }
    }()

    var body: some Scene {
        WindowGroup {
            ContentView()
                .environment(appState)
                .modelContainer(sharedModelContainer)
                .onAppear {
                    appState.configure(modelContext: sharedModelContainer.mainContext)
                }
        }
    }
}
```

**验收标准**:
- [ ] 所有基础文件已创建
- [ ] 代码可以编译（虽然会有错误，因为依赖的View还未创建）

---

## 五、创建占位View

为了让项目可以编译运行，我们需要创建所有被引用的View的占位版本。

### 5.1 创建 HomeView.swift

**位置**: `Features/Home/HomeView.swift`

**代码**:
```swift
import SwiftUI

struct HomeView: View {
    var body: some View {
        NavigationStack {
            ScrollView {
                VStack(spacing: 20) {
                    Text("首页")
                        .font(.largeTitle)
                        .bold()

                    Text("待实现")
                        .foregroundStyle(.secondary)
                }
                .padding()
            }
            .navigationTitle("球道")
        }
    }
}

#Preview {
    HomeView()
}
```

### 5.2 创建 OnboardingView.swift

**位置**: `Features/Home/OnboardingView.swift`

**代码**:
```swift
import SwiftUI

struct OnboardingView: View {
    @Binding var showOnboarding: Bool
    @Environment(AppState.self) private var appState

    var body: some View {
        VStack {
            Text("欢迎使用球道")
                .font(.largeTitle)
                .bold()

            Spacer()

            Button("开始使用") {
                appState.completeOnboarding()
                showOnboarding = false
            }
            .buttonStyle(.borderedProminent)
            .tint(.green)
        }
        .padding()
    }
}

#Preview {
    OnboardingView(showOnboarding: .constant(true))
        .environment(AppState())
}
```

### 5.3 创建其他占位View

按照相同方式创建以下占位View：

**CourseListView.swift** (`Features/Course/Views/CourseListView.swift`):
```swift
import SwiftUI

struct CourseListView: View {
    var body: some View {
        NavigationStack {
            Text("课程列表 - 待实现")
                .navigationTitle("课程")
        }
    }
}
```

**TrainingListView.swift** (`Features/Training/Views/TrainingListView.swift`):
```swift
import SwiftUI

struct TrainingListView: View {
    var body: some View {
        NavigationStack {
            Text("训练列表 - 待实现")
                .navigationTitle("训练")
        }
    }
}
```

**StatisticsView.swift** (`Features/Statistics/StatisticsView.swift`):
```swift
import SwiftUI

struct StatisticsView: View {
    var body: some View {
        NavigationStack {
            Text("统计 - 待实现")
                .navigationTitle("统计")
        }
    }
}
```

**SettingsView.swift** (`Features/Settings/SettingsView.swift`):
```swift
import SwiftUI

struct SettingsView: View {
    var body: some View {
        NavigationStack {
            Text("设置 - 待实现")
                .navigationTitle("设置")
        }
    }
}
```

**验收标准**:
- [ ] 所有占位View已创建
- [ ] 项目可以成功编译
- [ ] 可以在模拟器上运行
- [ ] 可以看到Tab导航
- [ ] 可以切换不同Tab

---

## 六、创建数据模型

### 6.1 创建 UserProfile.swift

**位置**: `Models/UserProfile.swift`

**代码**:
```swift
import Foundation
import SwiftData

@Model
class UserProfile {
    var id: UUID
    var nickname: String
    var level: Int
    var experience: Int
    var createdAt: Date
    var lastActiveAt: Date

    // 已购买的产品ID
    var purchasedProducts: [String]

    // 设置
    var soundEnabled: Bool
    var vibrationEnabled: Bool
    var aimLineEnabled: Bool
    var trajectoryEnabled: Bool

    init(
        nickname: String,
        level: Int = 1,
        experience: Int = 0
    ) {
        self.id = UUID()
        self.nickname = nickname
        self.level = level
        self.experience = experience
        self.createdAt = Date()
        self.lastActiveAt = Date()
        self.purchasedProducts = []
        self.soundEnabled = true
        self.vibrationEnabled = true
        self.aimLineEnabled = true
        self.trajectoryEnabled = false
    }

    // 等级相关
    var experienceForNextLevel: Int {
        switch level {
        case 1: return 500
        case 2: return 1500
        case 3: return 4000
        case 4: return 10000
        default: return 10000
        }
    }

    var experienceProgress: Double {
        Double(experience) / Double(experienceForNextLevel)
    }
}

@Model
class CourseProgress {
    var user: UserProfile?
    var courseId: Int
    var isCompleted: Bool
    var score: Int
    var practiceCount: Int
    var lastPracticeDate: Date?

    init(courseId: Int) {
        self.courseId = courseId
        self.isCompleted = false
        self.score = 0
        self.practiceCount = 0
    }
}

@Model
class UserStatistics {
    var user: UserProfile?
    var totalPracticeTime: TimeInterval
    var totalShots: Int
    var successfulShots: Int

    // 按角度统计
    var straightShotCount: Int
    var straightShotSuccess: Int
    var angle30Count: Int
    var angle30Success: Int
    var angle45Count: Int
    var angle45Success: Int
    var angle60Count: Int
    var angle60Success: Int

    init() {
        self.totalPracticeTime = 0
        self.totalShots = 0
        self.successfulShots = 0
        self.straightShotCount = 0
        self.straightShotSuccess = 0
        self.angle30Count = 0
        self.angle30Success = 0
        self.angle45Count = 0
        self.angle45Success = 0
        self.angle60Count = 0
        self.angle60Success = 0
    }

    var overallSuccessRate: Double {
        guard totalShots > 0 else { return 0 }
        return Double(successfulShots) / Double(totalShots)
    }
}

@Model
class TrainingSession {
    var id: UUID
    var user: UserProfile?
    var trainingType: String
    var startTime: Date
    var endTime: Date?
    var totalShots: Int
    var successfulShots: Int
    var score: Int

    init(trainingType: String) {
        self.id = UUID()
        self.trainingType = trainingType
        self.startTime = Date()
        self.totalShots = 0
        self.successfulShots = 0
        self.score = 0
    }

    var duration: TimeInterval {
        (endTime ?? Date()).timeIntervalSince(startTime)
    }

    var successRate: Double {
        guard totalShots > 0 else { return 0 }
        return Double(successfulShots) / Double(totalShots)
    }
}
```

**验收标准**:
- [ ] 数据模型已创建
- [ ] 项目可以编译
- [ ] SwiftData模型配置正确

---

## 七、测试基础架构

### 7.1 运行项目

**步骤**:
1. 选择模拟器（iPhone 15 Pro）
2. 点击运行按钮（Cmd + R）
3. 等待编译完成
4. 观察App启动

**预期结果**:
- App成功启动
- 首次启动显示引导页
- 点击"开始使用"后进入主界面
- 可以切换5个Tab
- 每个Tab显示占位内容

### 7.2 测试数据持久化

**步骤**:
1. 运行App
2. 完成引导
3. 关闭App（Cmd + Q）
4. 重新运行App
5. 观察是否直接进入主界面（不显示引导页）

**预期结果**:
- 第二次启动不显示引导页
- 用户数据已保存

### 7.3 测试真机运行

**步骤**:
1. 连接iPhone
2. 选择真机作为运行目标
3. 点击运行
4. 在真机上测试

**预期结果**:
- 可以在真机上运行
- 功能与模拟器一致

---

## 八、提交代码

### 8.1 检查代码

**步骤**:
```bash
# 查看修改的文件
git status

# 查看具体修改
git diff
```

### 8.2 提交代码

**步骤**:
```bash
# 添加所有文件
git add .

# 提交
git commit -m "feat: Complete project setup and basic architecture

- Created project directory structure
- Implemented AppState for global state management
- Created basic TabView navigation
- Implemented SwiftData models (UserProfile, CourseProgress, UserStatistics, TrainingSession)
- Created placeholder views for all main features
- Configured Git version control
"
```

**验收标准**:
- [ ] 代码已提交
- [ ] 提交信息清晰

---

## 九、文档更新

### 9.1 更新README

在项目根目录创建或更新 `README.md`：

```markdown
# 球道 - 台球训练App

## 项目状态
- [x] 项目搭建完成
- [x] 基础架构完成
- [ ] 物理引擎开发中
- [ ] 课程系统开发中

## 运行项目
1. 打开 `BilliardTrainer.xcodeproj`
2. 选择模拟器或真机
3. 点击运行（Cmd + R）

## 技术栈
- Swift 5.x
- SwiftUI
- SceneKit
- SwiftData

## 最低要求
- iOS 17.0+
- Xcode 15.0+
```

---

## 十、验收清单

### 最终验收

- [ ] Xcode项目已创建
- [ ] 项目配置正确（Bundle ID、版本号、最低iOS版本）
- [ ] 目录结构完整
- [ ] Git版本控制已配置
- [ ] AppState已实现
- [ ] SwiftData模型已创建
- [ ] 所有占位View已创建
- [ ] 项目可以成功编译
- [ ] 可以在模拟器上运行
- [ ] 可以在真机上运行
- [ ] Tab导航正常工作
- [ ] 引导页功能正常
- [ ] 数据持久化正常
- [ ] 代码已提交到Git
- [ ] README已更新

---

## 下一步

完成本步骤后，继续进行：
- **步骤2**: SceneKit场景搭建
- **步骤3**: 物理引擎实现

---

**预计完成时间**: 2-3天
**实际完成时间**: ___________
**遇到的问题**: ___________
**解决方案**: ___________
