# 功能规格：物理调优 (Physics Tuning)

**功能分支**: `10-physics-tuning`  
**创建日期**: 2025-02-20  
**状态**: 草案 (Draft)  
**优先级**: P1  
**说明**: 球道 (Billiard Trainer) iOS App 物理引擎精细化调优规格

---

## 概述

球道 App 物理引擎已完成约 85%，具备事件驱动架构、塞球系统、Alciatore/Mathavan 碰撞模型及轨迹预测等能力。本规格聚焦于**物理参数校准**、**轨迹预测 UI 优化**、**障碍球检测**及**整体手感调优**，使模拟体验逼近真实台球。

---

## 用户故事

### US1 - 旋转参数校准 [P1]

**作为** 台球训练者，  
**我希望** 高杆、低杆、左塞/右塞的效果与真实台球一致，  
**以便** 在训练中养成正确的杆法判断与肌肉记忆。

**验收场景**:
1. **Given** 使用高杆击打母球 **When** 母球与目标球碰撞 **Then** 母球分离角小于 90°，具有明显跟进效果
2. **Given** 使用低杆击打母球 **When** 母球与目标球碰撞 **Then** 母球分离角大于 90°，具有明显拉回效果
3. **Given** 使用侧旋击打母球 **When** 母球碰撞库边 **Then** 反弹角度受侧旋影响，与真实台球现象一致
4. **Given** 母球带旋转碰撞目标球 **When** 发生碰撞 **Then** 目标球获得适当的旋转传递，运动轨迹自然

---

### US2 - 碰撞参数校准 [P1]

**作为** 台球训练者，  
**我希望** 球与球、球与库边的碰撞响应与真实球台一致，  
**以便** 翻袋、K 球、颗星等高级技术训练有效。

**验收场景**:
1. **Given** 母球以中等速度撞击库边 **When** 反弹 **Then** 能量损失（弹性系数）与真实库边相近
2. **Given** 两球以一定速度正碰 **When** 碰撞 **Then** 能量传递与真实球体相近
3. **Given** 母球在台面滚动 **When** 无外力 **Then** 速度衰减速率与真实台呢摩擦相符
4. **Given** 不同库边（角袋附近 vs 中袋附近）**When** 碰撞 **Then** 若有差异，可按库边类型分别调参

---

### US3 - 轨迹预测 UI 优化 [P2]

**作为** 瞄准中的训练者，  
**我希望** 预测轨迹清晰、准确，并能区分母球与目标球路径，  
**以便** 快速判断击球效果并修正瞄准。

**验收场景**:
1. **Given** 用户处于瞄准状态 **When** 移动瞄准方向 **Then** 预测轨迹实时更新，无卡顿
2. **Given** 多库反弹击球 **When** 显示预测轨迹 **Then** 多库路径预测基本准确，误差在可接受范围
3. **Given** 预测轨迹与实际轨迹 **When** 击球完成回放 **Then** 预测线与实际线在视觉上可清晰区分（颜色/样式）
4. **Given** 预测轨迹 **When** 在不同视角下查看 **Then** 线条粗细、透明度、点距适合阅读

---

### US4 - 障碍球检测 [P2]

**作为** 瞄准中的训练者，  
**我希望** 在瞄准线被其他球遮挡时得到明确提示，  
**以便** 避免无效击球，或主动寻求绕行路径。

**验收场景**:
1. **Given** 瞄准线与目标球之间存在障碍球 **When** 用户瞄准 **Then** 显示「阻挡」或类似视觉提示
2. **Given** 瞄准线畅通 **When** 用户瞄准 **Then** 不显示阻挡提示
3. **Given** 存在阻挡 **When** 用户询问 **Then** 可计算并显示绕行路径（可选，进阶功能）
4. **Given** 多球遮挡 **When** 检测 **Then** 正确识别最近的有效障碍球

---

### US5 - 整体手感调优 [P1]

**作为** 台球训练者，  
**我希望** 球的移动速度、旋转可见性、库边反弹在观感上自然真实，  
**以便** 训练体验接近实际练球。

**验收场景**:
1. **Given** 轻杆、中杆、重杆击球 **When** 观察 **Then** 球速差异明显且符合直觉
2. **Given** 施加塞球 **When** 观察母球运动 **Then** 旋转效果可见但不过度夸张
3. **Given** 库边反弹 **When** 观察 **Then** 角度与能量损失符合真实感
4. **Given** 球静止前 **When** 观察 **Then** 滑动→滚动→旋转→静止过渡自然，无突兀跳动

---

## 需求

### 功能需求

| ID | 需求 |
|----|------|
| FR-001 | 系统必须提供可调的旋转参数：spinDecayRate（旋转衰减率）、spinTransferRate（碰撞时旋转传递率）、englishCushionEffect（侧旋对库边反弹的影响系数） |
| FR-002 | 系统必须对高杆/低杆的旋转幅值与衰减率进行实场校准，使分离角现象与真实一致 |
| FR-003 | 系统必须对侧旋在库边反弹时对出射角的影响进行校准 |
| FR-004 | 系统必须对球-球碰撞时的旋转传递进行校准 |
| FR-005 | 系统必须提供可调的碰撞参数：cushionRestitution（库边弹性）、ballBallRestitution（球-球弹性）、clothFriction（台呢摩擦） |
| FR-006 | 系统应支持按库边类型（如角袋短边、长边、中袋附近）分别配置弹性系数 |
| FR-007 | 轨迹预测 UI 必须清晰区分母球路径与目标球路径 |
| FR-008 | 轨迹预测 UI 必须支持多库反弹预测，并保证一定精度 |
| FR-009 | 系统必须实现障碍球检测：沿瞄准线射线检测，判断是否有球阻挡母球与目标球连线 |
| FR-010 | 系统必须在检测到阻挡时显示明确视觉反馈 |
| FR-011 | 球体运动速度、旋转效果、库边反弹在主观感受上应自然真实 |

### 关键参数（当前值与待校准范围）

| 参数 | 当前值 | 所在模块 | 说明 |
|------|--------|----------|------|
| spinDecayRate | 0.98（或等效） | SpinPhysics / 旋转衰减逻辑 | 每帧角速度衰减系数 |
| spinTransferRate | 0.3（待引入） | CollisionResolver 球-球 | 碰撞时旋转传递给目标球的比例 |
| englishCushionEffect | 0.12（待引入） | CushionCollisionModel / 库边反弹 | 侧旋对出射角的修正系数 |
| cushionRestitution | 0.85 | TablePhysics | 库边弹性系数 |
| ballBallRestitution | 0.95 | BallPhysics.restitution | 球-球弹性系数 |
| clothFriction | 0.2 | TablePhysics / SpinPhysics | 台呢滑动摩擦系数 |

---

## 成功标准

| ID | 标准 |
|----|------|
| SC-001 | 高杆/低杆分离角与理论值偏差 < 10°（在标准碰撞条件下） |
| SC-002 | 侧旋库边效果在定性上与专业文献或实球一致 |
| SC-003 | 球-球、球-库边能量损失在可调范围内，且调参后有明显改善 |
| SC-004 | 轨迹预测多库反弹与 EventDrivenEngine 回放轨迹偏差 < 15% 路径长度 |
| SC-005 | 障碍球检测在标准摆放下准确率 100% |
| SC-006 | 通过至少 5 名台球爱好者主观手感测试，平均评分 ≥ 4/5 |

---

## 边界与约束

- 调参不改变现有 EventDrivenEngine、AnalyticalMotion、CollisionResolver 的核心算法结构
- 新增参数通过 PhysicsConstants 或配置注入，便于 A/B 测试与后续迭代
- 障碍球检测仅在瞄准阶段启用，不影响击球执行与物理模拟
- 轨迹预测 UI 性能：更新延迟 < 100ms，不阻塞主线程

---

## 参考资料

- Alciatore: "TP_A-30 / TP_A-31" 击球与 Squirt 模型
- Mathavan 2010: 库边冲量积分模型
- pooltool: spinFrictionProportionality 等参考值
- 中式八球标准：球 57.15mm、球台 2540×1270mm
