# 功能规格：场景渲染 (Scene Rendering)

**功能分支**：`2-scene-rendering`  
**创建日期**：2025-02-20  
**状态**：已完成 (回溯记录)  
**完成度**：90%

## 用户场景与验收

### 用户故事 1 - 3D 台球场景展示 (优先级: P1)

用户进入训练场后，能看到完整的 3D 台球桌面、球体、球杆及光照效果，场景渲染流畅、视觉真实。

**优先级说明**：核心体验，用户首先需要看到可操作的 3D 场景。

**独立验收**：进入训练场，确认球台、球、球杆正确显示，光照自然，帧率稳定。

**验收场景**：

1. **Given** 应用已启动，**When** 用户进入训练场，**Then** 3D 台球场景正确渲染，球台和球体可见
2. **Given** 场景已加载，**When** 用户观察场景，**Then** 光照、阴影、材质效果符合预期
3. **Given** 场景在运行，**When** 用户进行交互，**Then** 渲染保持 60fps 流畅

---

### 用户故事 2 - 多视角切换 (优先级: P2)

用户可通过手势或按钮切换不同相机视角：俯视 2D、透视 3D、击球视角、自由视角，以适配不同的练习与观察需求。

**优先级说明**：多视角能提升教学与复盘体验。

**独立验收**：双击或切换按钮，视角在四种模式间正确切换，相机位置与角度符合各模式定义。

**验收场景**：

1. **Given** 场景已加载，**When** 用户双击屏幕，**Then** 相机切换到下一视角模式（第一人称 → 俯视 → 透视 → 自由 → 循环）
2. **Given** 当前为俯视模式，**When** 用户观察球台，**Then** 采用正交投影，自上而下 90° 俯视
3. **Given** 当前为击球模式，**When** 用户观察球台，**Then** 相机以约 15° 仰角对准击球方向
4. **Given** 当前为透视模式，**When** 用户观察球台，**Then** 相机以约 45° 俯角 3D 透视

---

### 用户故事 3 - 手势控制视角 (优先级: P2)

用户可通过单指拖动旋转视角、双指捏合缩放、双指平移调整俯仰角，直观操控 3D 场景。

**优先级说明**：手势控制是移动端必备交互。

**独立验收**：在自由或第一人称模式下，单指/双指手势正确改变相机位置与缩放。

**验收场景**：

1. **Given** 场景已加载，**When** 用户单指拖动，**Then** 视角围绕球台中心旋转
2. **Given** 场景已加载，**When** 用户双指捏合，**Then** 视角缩放（zoom in/out）
3. **Given** 第一人称模式，**When** 用户双指捏合，**Then** 球杆与相机距离随缩放调整

---

### 边界情况

- 当 USDZ 模型加载失败时，系统应降级为程序化生成的球台与球杆
- 当场景节点过多时，应保持渲染帧率，不出现明显卡顿
- 当设备性能较低时，可适当降低抗锯齿或阴影质量

## 功能需求

### 功能需求

- **FR-001**：系统必须使用 SceneKit 进行 3D 场景渲染
- **FR-002**：系统必须支持 USDZ 球台模型加载，包含坐标系转换（Z-up → Y-up）与缩放适配
- **FR-003**：系统必须提供 BilliardScene 管理场景节点（球台、球、相机、灯光）
- **FR-004**：系统必须提供 BilliardSceneView 实现 SwiftUI 集成、手势处理与渲染循环
- **FR-005**：系统必须支持四种相机模式：第一人称击球、俯视 2D、透视 3D、击球视角、自由视角
- **FR-006**：系统必须支持单指拖拽旋转、双指捏合缩放、双击切换视角
- **FR-007**：系统必须采用视觉-物理分离架构：SceneKit 仅负责渲染，不参与物理计算
- **FR-008**：系统必须支持球杆可视化（USDZ 模型或程序化生成）
- **FR-009**：系统必须提供 TableGeometry 描述球台几何（库边、袋口、钻石点）

### 关键实体

- **BilliardScene**：场景管理器，持有球台、球、相机、灯光等节点
- **BilliardSceneView**：SwiftUI 包装的 SceneKit 视图，负责手势与渲染循环
- **TableModelLoader**：USDZ 球台模型加载器，处理坐标系转换与缩放
- **TableGeometry**：球台几何描述（线性库边、圆弧库边、袋口）
- **CueStick**：球杆 3D 模型（USDZ 或程序化）

## 成功标准

### 可衡量结果

- **SC-001**：场景在常用设备上以 60fps 稳定渲染
- **SC-002**：USDZ 模型正确加载并适配场景坐标系，球台与球位置对齐
- **SC-003**：四种相机模式切换流畅，无明显视角跳变
- **SC-004**：手势响应延迟低于 100ms，交互自然
- **SC-005**：视觉与物理完全解耦，物理引擎可独立更换而不影响渲染

---

## 源文件

| 文件 | 路径 |
|------|------|
| BilliardScene | Core/Scene/BilliardScene.swift |
| BilliardSceneView | Core/Scene/BilliardSceneView.swift |
| TableModelLoader | Core/Scene/TableModelLoader.swift |
| TableGeometry | Core/Scene/TableGeometry.swift |
| CueStick | Core/Scene/CueStick.swift |
