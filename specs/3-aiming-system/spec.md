# 功能规格：瞄准系统 (Aiming System)

**功能分支**：`3-aiming-system`  
**创建日期**：2025-02-20  
**状态**：已完成 (回溯记录)  
**完成度**：80%

## 用户场景与验收

### 用户故事 1 - 直线瞄准辅助 (优先级: P1)

用户在练习击球时，能通过瞄准线、假想球（幽灵球）可视化瞄准点，理解母球应击打目标球的哪个接触点才能进袋。

**优先级说明**：瞄准辅助是训练应用的核心价值，帮助用户理解几何瞄准原理。

**独立验收**：选择目标球与袋口，瞄准线指向正确接触点，假想球位于目标球到袋口反方向 2R 处。

**验收场景**：

1. **Given** 母球与目标球已摆放，**When** 用户选择目标球与袋口，**Then** 瞄准线从母球指向假想球中心
2. **Given** 瞄准已计算，**When** 用户观察假想球，**Then** 假想球位于目标球到袋口方向的反向 2R 处（幽灵球法）
3. **Given** 用户调整瞄准，**When** 击球，**Then** 击球方向与瞄准线一致

---

### 用户故事 2 - 分离角与走位 (优先级: P2)

用户能了解击球后的分离角，以及母球预计停止位置，用于走位规划。

**优先级说明**：分离角与走位是进阶训练的重要辅助。

**独立验收**：计算不同厚度（thickness）下的分离角，显示母球预计停止区域，并与实际物理结果大体一致。

**验收场景**：

1. **Given** 瞄准已计算，**When** 用户查看瞄准结果，**Then** 显示分离角（度）
2. **Given** 瞄准已计算，**When** 用户查看走位，**Then** 显示母球预计停止位置或区域评分
3. **Given** 正撞（厚度 1），**When** 计算分离角，**Then** 分离角约为 90°

---

### 用户故事 3 - 颗星公式 (优先级: P2)

用户能使用颗星公式计算一库、两库、三库翻袋或 K 球的击球点。

**优先级说明**：颗星公式是职业选手常用的辅助系统，提升高阶训练价值。

**独立验收**：输入母球、目标球/袋口位置，颗星计算器返回第一库接触点颗星数及公式说明。

**验收场景**：

1. **Given** 母球与目标袋口位置，**When** 调用一库翻袋计算，**Then** 返回第一库颗星数与公式
2. **Given** 母球与目标球位置及第一库边，**When** 调用两库 K 球计算，**Then** 返回第一库颗星数
3. **Given** 颗星计算结果，**When** 需要塞或力度修正，**Then** 返回推荐塞（左右塞）与力度建议

---

### 用户故事 4 - 塞与速度修正 (优先级: P3)

颗星计算支持塞（English）修正与速度修正，提高实际击球准确性。

**优先级说明**：塞与速度会影响颗星实际落点，是进阶修正。

**独立验收**：传入塞与力度参数，颗星结果包含修正后的建议；瞄准计算支持 squirt 角修正。

**验收场景**：

1. **Given** 两库 K 球计算，**When** 角度较大，**Then** 推荐使用反塞压线
2. **Given** 瞄准计算，**When** 用户设置左右塞，**Then** 应用 squirt 角修正击球方向
3. **Given** 力度较大，**When** 颗星计算，**Then** 推荐减少颗星数以补偿长距离

---

### 边界情况

- 当目标球与袋口连线被其他球遮挡时，应标记路径被遮挡
- 当厚度为 0（切线）时，分离角计算应合理处理
- 当母球或目标球在袋口附近时，颗星计算应返回 nil 或提示无效

## 功能需求

### 功能需求

- **FR-001**：系统必须使用幽灵球法计算进袋瞄准点
- **FR-002**：系统必须计算厚度（thickness，0-1），并据此计算分离角
- **FR-003**：系统必须支持位置区域评分（PositionZone），用于走位难度评估
- **FR-004**：系统必须实现颗星公式：一库、两库、三库计算
- **FR-005**：系统必须支持塞（English）修正用于颗星计算
- **FR-006**：系统必须支持速度（力度）修正用于颗星计算
- **FR-007**：系统必须支持 squirt 角修正（侧旋导致击球方向偏移）
- **FR-008**：系统必须提供路径遮挡检测（isPathOccluded）

### 关键实体

- **AimingCalculator**：瞄准计算器，幽灵球、厚度、分离角、走位预测、难度评分
- **AimResult**：瞄准结果（aimPoint, aimDirection, thickness, separationAngle, canPocket, difficulty）
- **DiamondSystemCalculator**：颗星公式计算器
- **DiamondResult**：颗星结果（startDiamond, firstRailDiamond, recommendedEnglish, formula）

## 成功标准

### 可衡量结果

- **SC-001**：幽灵球位置与几何瞄准原理一致，正撞时假想球在目标球正后方
- **SC-002**：分离角计算与物理引擎结果偏差在合理范围内（如 ±5°）
- **SC-003**：一库、两库颗星公式在标准球台上计算正确
- **SC-004**：塞与速度修正能改善实际击球与颗星预测的吻合度

---

## 源文件

| 文件 | 路径 |
|------|------|
| AimingSystem | Core/Aiming/AimingSystem.swift |
| DiamondSystem | Core/Aiming/DiamondSystem.swift |
