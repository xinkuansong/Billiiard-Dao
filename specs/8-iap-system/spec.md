# 功能规格：内购系统 (IAP System)

**功能分支**: `8-iap-system`  
**创建日期**: 2026-02-20  
**状态**: 草案 (Draft)  
**完成度**: 0%  
**说明**: 球道 (Billiard Trainer) iOS App 内购系统，负责课程包与训练场的解锁。纯付费商业模式，无广告，使用 StoreKit 2 实现。

## 概述

内购系统为应用提供课程包与训练场的付费解锁能力。用户可购买四个非消耗型产品：基础课程包、进阶课程包、高级课程包、全功能解锁。购买后对应课程（L4–L18）与训练场永久解锁，支持恢复购买以满足 App Store 合规要求。无需用户账户，完全基于本地存储与 Apple 收据验证。

## 商业模式

| 产品名称   | 价格   | Product ID                | 类型       | 包含内容 |
|------------|--------|---------------------------|------------|----------|
| 基础课程包 | ¥18    | com.app.course.basic      | 非消耗型   | L4–L8 课程 + 杆法训练场 |
| 进阶课程包 | ¥25    | com.app.course.advanced   | 非消耗型   | L9–L14 课程 + 翻袋/K球/传球/颗星训练场 |
| 高级课程包 | ¥20    | com.app.course.expert     | 非消耗型   | L15–L18 课程 + 解球训练场 + 清台挑战 |
| 全功能解锁 | ¥48    | com.app.course.full       | 非消耗型   | 所有课程与训练场 |

## 用户故事 (User Stories)

### 用户故事 1 - 浏览与购买课程包 (优先级: P1)

用户进入「已购内容」或课程/训练列表，可查看各课程包的价格与内容描述。点击购买按钮后，弹出购买确认对话框，确认后完成支付，课程与训练场即时解锁。

**独立测试**: 沙盒环境下点击购买，完成 StoreKit 流程，对应内容解锁。

**验收场景**:
1. **Given** 已购内容页，**When** 加载，**Then** 显示各课程包名称、价格（来自 StoreKit）、包含内容描述
2. **Given** 用户点击某一课程包购买按钮，**When** 触发，**Then** 弹出购买确认对话框（含价格、产品名、确认/取消）
3. **Given** 用户确认购买，**When** 完成 StoreKit 支付流程，**Then** 对应课程与训练场解锁，UI 更新
4. **Given** 已解锁内容，**When** 用户进入课程或训练页，**Then** 可正常访问，无锁定状态

---

### 用户故事 2 - 恢复购买 (优先级: P1)

用户在换机、重装或登录不同 Apple ID 后，可通过「恢复购买」恢复此前已购的课程包，无需重复付费。

**独立测试**: 沙盒购买后清除本地缓存，点击恢复购买，已购内容正确恢复。

**验收场景**:
1. **Given** 设置页，**When** 用户点击「恢复购买」，**Then** 触发 StoreKit 恢复流程，显示加载状态
2. **Given** 恢复成功，**When** Apple 返回有效交易，**Then** 更新本地购买状态，已购课程与训练场解锁
3. **Given** 恢复成功但无历史购买，**When** 流程结束，**Then** 显示「未发现购买记录」或类似提示
4. **Given** 恢复失败（网络/权限等），**When** 流程结束，**Then** 显示友好错误提示，建议稍后重试

---

### 用户故事 3 - 购买前确认 (优先级: P1)

用户在点击购买后、实际扣款前，必须看到购买确认对话框，明确展示产品名称、价格，用户可选择确认或取消。

**独立测试**: 点击购买后，确认对话框出现；取消则无扣款；确认则进入 StoreKit 支付。

**验收场景**:
1. **Given** 用户点击任意课程包购买，**When** 触发，**Then** 先弹出确认对话框，不直接发起 StoreKit 购买
2. **Given** 确认对话框，**When** 用户点击取消，**Then** 关闭对话框，无扣款、无状态变更
3. **Given** 确认对话框，**When** 用户点击确认，**Then** 发起 StoreKit 购买流程

---

### 用户故事 4 - 内容解锁逻辑 (优先级: P1)

已购课程包与对应课程、训练场的解锁关系正确。全功能解锁等价于购买全部三个分课程包。

**独立测试**: 分别购买各包，验证课程列表与训练场列表的解锁状态与规格一致。

**验收场景**:
1. **Given** 购买基础课程包，**When** 购买成功，**Then** L4–L8 课程、杆法训练场解锁
2. **Given** 购买进阶课程包，**When** 购买成功，**Then** L9–L14 课程、翻袋/K球/传球/颗星训练场解锁
3. **Given** 购买高级课程包，**When** 购买成功，**Then** L15–L18 课程、解球训练场、清台挑战解锁
4. **Given** 购买全功能解锁，**When** 购买成功，**Then** 所有课程与训练场解锁
5. **Given** 课程列表/训练列表，**When** 渲染，**Then** 根据购买状态显示锁定/解锁图标与可点击性

---

### 用户故事 5 - 购买失败处理 (优先级: P1)

当购买因网络、用户取消、权限或 StoreKit 错误而失败时，应用应优雅处理，不闪退，并给出可理解的提示。

**独立测试**: 模拟网络断开、用户取消、沙盒账号问题等，验证错误提示与状态恢复。

**验收场景**:
1. **Given** 购买流程中，**When** 用户取消支付（系统对话框），**Then** 回到应用，显示「已取消」或类似提示，无异常状态
2. **Given** 购买流程中，**When** 网络不可用，**Then** 显示「网络错误，请检查网络后重试」
3. **Given** 购买流程中，**When** StoreKit 返回 .failed 等错误，**Then** 显示通用错误提示，建议联系支持或稍后重试
4. **Given** 任何失败场景，**When** 错误发生，**Then** 应用不闪退，购买按钮可再次点击

---

### 用户故事 6 - 已购内容展示 (优先级: P2)

用户在「已购内容」页可清晰看到已解锁与未解锁的课程包，已购项显示「已购买」或类似标识，未购项显示价格与购买入口。

**独立测试**: 购买前后，已购内容页正确反映状态。

**验收场景**:
1. **Given** 已购内容页，**When** 某课程包已购，**Then** 显示「已解锁」或勾选标识，无购买按钮
2. **Given** 已购内容页，**When** 某课程包未购，**Then** 显示价格与购买按钮
3. **Given** 全功能已购，**When** 渲染，**Then** 所有包显示已解锁

---

### 边界情况

- **无网络启动**: 应用启动时若无网络，已缓存的购买状态应仍可用；恢复购买需网络
- **沙盒账号切换**: 沙盒测试时切换账号，恢复购买应返回该账号的交易
- **家庭共享**: 可选支持 Family Sharing，若启用则同家庭组可共享非消耗型购买
- **收据验证**: 仅依赖 Apple StoreKit 2 的 `Transaction` 验证，不另建服务器
- **重复购买**: 非消耗型产品 StoreKit 会阻止重复扣款，本地逻辑应幂等
- **产品未配置**: App Store Connect 未配置或产品 ID 错误时，产品列表为空，应提示「暂无可购买内容」

## 功能需求 (Functional Requirements)

### 核心需求

- **FR-001**: 使用 StoreKit 2 现代异步 API（`Product`、`Transaction`、`Transaction.currentEntitlements`）
- **FR-002**: 必须实现恢复购买功能（宪法 MUST 要求）
- **FR-003**: 购买前必须弹出确认对话框，展示产品名、价格、确认/取消
- **FR-004**: 购买失败时必须有友好错误提示，不闪退
- **FR-005**: 内容解锁逻辑：基础包 → L4–L8 + 杆法训练场；进阶包 → L9–L14 + 翻袋/K球/传球/颗星训练场；高级包 → L15–L18 + 解球训练场 + 清台挑战；全功能 → 全部
- **FR-006**: 所有购买为非消耗型，一次购买终身使用
- **FR-007**: 无需用户账户，纯本地 + Apple 收据验证
- **FR-008**: 目标 iOS 17+，StoreKit 2 兼容

### 可选需求

- **FR-009**: 支持 Family Sharing（在 App Store Connect 中配置）

### 产品配置

| Product ID              | 显示名称   | 价格   | 类型       |
|-------------------------|------------|--------|------------|
| com.app.course.basic    | 基础课程包 | ¥18    | 非消耗型   |
| com.app.course.advanced | 进阶课程包 | ¥25    | 非消耗型   |
| com.app.course.expert   | 高级课程包 | ¥20    | 非消耗型   |
| com.app.course.full     | 全功能解锁 | ¥48    | 非消耗型   |

## 成功标准 (Success Criteria)

### 可衡量结果

- **SC-001**: 沙盒环境下可完成任意课程包购买，对应内容正确解锁
- **SC-002**: 恢复购买可正确恢复历史交易，课程与训练场状态与购买一致
- **SC-003**: 购买前确认对话框始终展示，取消不会扣款
- **SC-004**: 网络错误、用户取消、权限问题等失败场景有明确提示，无崩溃
- **SC-005**: CourseListView、TrainingListView 的锁定/解锁状态与 IAP 购买状态一致
- **SC-006**: SettingsView「恢复购买」按钮可触发恢复流程并反馈结果
- **SC-007**: PurchasedContentView 正确展示已购/未购状态与价格

## 现有代码引用

| 文件 | 说明 |
|------|------|
| SettingsView.swift | 购买管理 Section、恢复购买按钮（TODO 占位） |
| CourseListView.swift | 课程分组、锁定状态（isLocked 硬编码） |
| TrainingListView.swift | 训练场列表、TrainingGround.isLocked |
| UserProfile.swift | purchasedProducts 数组，当前未与 StoreKit 同步 |
| PurchasedContentView | 已购内容页 UI 框架，价格与购买按钮为占位 |

## 依赖

- 宪法：MUST 提供恢复购买功能
- 5-base-ui：SettingsView、PurchasedContentView 已存在
- 课程/训练模块：Course 模型、TrainingGround 模型、CourseSection、TrainingGroundCard
